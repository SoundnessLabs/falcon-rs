//! Generate test vectors for cross-implementation verification.
//!
//! This binary generates Falcon signatures that can be verified by the Python
//! implementation (with appropriate bit order conversion) or any C-compatible
//! implementation.
//!
//! Usage: cargo run --bin generate_vectors

use falcon::{Falcon1024, Falcon512, FalconParams, KeyPair, SignatureFormat};
use std::fs;

fn generate_vectors<P: FalconParams>(name: &str, seed: &[u8; 48]) -> serde_json::Value {
    let keypair = KeyPair::<P>::generate_from_seed(seed).expect("Failed to generate keypair");

    let binary_message: Vec<u8> = (0..100).map(|i| i as u8).collect();
    let messages: Vec<&[u8]> = vec![
        b"Hello, Falcon!",
        b"Test message for cross-implementation verification",
        b"",
        &binary_message,
    ];

    let mut vectors = Vec::new();

    for (i, message) in messages.iter().enumerate() {
        let sig = keypair
            .sign_with_seed(message, SignatureFormat::Padded, seed)
            .expect("Failed to sign");

        vectors.push(serde_json::json!({
            "test_id": format!("{}_{}", name, i),
            "message_hex": hex::encode(message),
            "signature_hex": hex::encode(sig.as_bytes()),
            "signature_len": sig.len(),
        }));
    }

    serde_json::json!({
        "name": name,
        "public_key_hex": hex::encode(keypair.public_key().as_bytes()),
        "public_key_len": keypair.public_key().as_bytes().len(),
        "vectors": vectors,
    })
}

fn main() {
    let seed: [u8; 48] = std::array::from_fn(|i| (i * 7 + 42) as u8);

    println!("Generating Rust Falcon test vectors...");
    println!("Seed: {}", hex::encode(&seed));

    let falcon512 = generate_vectors::<Falcon512>("falcon512", &seed);
    let falcon1024 = generate_vectors::<Falcon1024>("falcon1024", &seed);

    let output = serde_json::json!({
        "description": "Falcon test vectors generated by Rust implementation",
        "seed_hex": hex::encode(&seed),
        "note": "Signatures use C reference encoding (LSB-first bit packing)",
        "falcon512": falcon512,
        "falcon1024": falcon1024,
    });

    let json_str = serde_json::to_string_pretty(&output).expect("Failed to serialize");

    // Write to file
    let output_path = "rust_test_vectors.json";
    fs::write(output_path, &json_str).expect("Failed to write file");

    println!("Test vectors written to {}", output_path);
    println!("\nTo verify with Python, run:");
    println!("  python3 verify_rust_vectors.py");
}
